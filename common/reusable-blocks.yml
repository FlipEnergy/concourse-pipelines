# credential blocks
docker_creds: &docker_creds
  username: ((docker_hub_username))
  password: ((docker_hub_password))

github_creds: &github_creds
  username: ((github_username))
  password: ((github_password))

github_access_token: &github_access_token
  access_token: ((github_password))

# resource types
webhook-resource-type: &webhook-resource-type
  name: webhook-resource-type
  type: registry-image
  source:
    <<: *docker_creds
    repository: flavorjones/webhook-notification-resource
    tag: v1.1.0

# resources
discord_general: &discord_general
  name: discord_general
  type: webhook-resource-type
  icon: bell
  source:
      adapter: DiscordAdapter
      url: ((discord_general_webhook_url))
  check_every: never

discord_healthy_habits: &discord_healthy_habits
  name: discord_healthy_habits
  type: webhook-resource-type
  icon: bell
  source:
      adapter: DiscordAdapter
      url: ((discord_healthy_habits_webhook_url))
  check_every: never

concourse-pipelines-repo: &concourse-pipelines-repo
  name: concourse-pipelines-repo
  type: git
  icon: github
  source:
    <<: *github_creds
    uri: https://github.com/FlipEnergy/concourse-pipelines.git
    branch: main
  check_every: 30m

# task image resources
alpine-image-resource: &alpine-image-resource
  type: registry-image
  source:
    <<: *docker_creds
    repository: alpine
    tag: 3.14

bitwarden-cli-image-resource: &bitwarden-cli-image-resource
  type: registry-image
  source:
    <<: *docker_creds
    repository: flipenergy/bitwarden-cli
    tag: latest

helmsman-image-resource: &helmsman-image-resource
  type: registry-image
  source:
    <<: *docker_creds
    repository: praqma/helmsman
    tag: latest

helm-image-resource: &helm-image-resource
  type: registry-image
  source:
    <<: *docker_creds
    repository: alpine/helm
    tag: latest

oci-build-image-resource: &oci-build-image-resource
  type: registry-image
  source:
    <<: *docker_creds
    repository: concourse/oci-build-task
    tag: 0.9.0

yq-image-resource: &yq-image-resource
  type: registry-image
  source:
    <<: *docker_creds
    repository: flipenergy/yq-ubuntu
    tag: latest

# notifications
notify-failure: &notify-failure
  put: discord_general
  params:
    message: "**FAILED** :boom: **[${BUILD_PIPELINE_NAME}/${BUILD_JOB_NAME}/${BUILD_NAME}](${BUILD_URL})**"

job_notifications: &job_notifications
  on_success:
    put: discord_general
    params:
      message: "**SUCCESS** :rocket: **[${BUILD_PIPELINE_NAME}/${BUILD_JOB_NAME}/${BUILD_NAME}](${BUILD_URL})**"
  on_error: *notify-failure
  on_failure: *notify-failure

# tasks
get_secret_key_task: &get_secret_key_task
  task: get-secret-key
  config:
    platform: linux
    image_resource: *bitwarden-cli-image-resource

    inputs:
      - name: concourse-pipelines-repo

    outputs:
      - name: concourse-pipelines-repo
      - name: secrets

    params:
      BW_ITEM: ((bitwarden_item))
      BW_SERVER: ((bitwarden_server))
      BW_USERNAME: ((bitwarden_username))
      BW_PASSWORD: ((bitwarden_password))

    run:
      path: concourse-pipelines-repo/common/scripts/get-secret-key.sh

# end reusable blocks
