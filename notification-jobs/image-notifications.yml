# begin resource templates
resource_options: &resource_options
  type: registry-image
  icon: docker
  check_every: 30m
# end resource templates

resource_types:
  - *webhook-resource-type

resources:
  - *discord-image

  - name: &ihatemoney_resource ihatemoney-docker-repo
    <<: *resource_options
    source:
      <<: *docker-creds
      repository: ihatemoney/ihatemoney

  - name: &oci_resource oci-build-task-docker-repo
    <<: *resource_options
    source:
      <<: *docker-creds
      repository: concourse/oci-build-task

  - name: &owncast_resource owncast-docker-repo
    <<: *resource_options
    source:
      <<: *docker-creds
      repository: gabekangas/owncast

  - name: &jellyfin_resource jellyfin-docker-repo
    <<: *resource_options
    source:
      <<: *docker-creds
      repository: jellyfin/jellyfin

  - name: &vaultwarden_resource vaultwarden-docker-repo
    <<: *resource_options
    source:
      <<: *docker-creds
      repository: vaultwarden/server

  - name: &wikijs_resource wikijs-docker-repo
    <<: *resource_options
    source:
      <<: *docker-creds
      repository: requarks/wiki

# begin job templates
get_options: &get_options
  params:
    skip_download: true
  trigger: true

build_message_config: &build_message_config
  platform: linux
  image_resource: *alpine-image-resource
  outputs:
    - name: message
  run:
    path: sh
    args:
      - -ec
      - >
        echo ":new: **[${IMAGE_NAME}" 'image tag](${BUILD_URL})**' $(cat ${RESOURCE_DIR}/tag) "[release notes](${RELEASE_URL})"> message/message.txt

discord_notification: &discord_notification
  put: discord-image
  params:
    message_file: /tmp/build/put/message/message.txt
# end job templates

jobs:
  - name: ihatemoney
    plan:
      - get: *ihatemoney_resource
        <<: *get_options

      - task: build-message
        config:
          <<: *build_message_config
          inputs:
            - name: *ihatemoney_resource
          params:
            IMAGE_NAME: ihatemoney
            RELEASE_URL: https://github.com/spiral-project/ihatemoney/releases
            RESOURCE_DIR: *ihatemoney_resource
      - *discord_notification

  - name: jellyfin
    plan:
      - get: *jellyfin_resource
        <<: *get_options

      - task: build-message
        config:
          <<: *build_message_config
          inputs:
            - name: *jellyfin_resource
          params:
            IMAGE_NAME: Jellyfin
            RELEASE_URL: https://github.com/jellyfin/jellyfin/releases
            RESOURCE_DIR: *jellyfin_resource
      - *discord_notification

  - name: oci-build-task
    plan:
      - get: *oci_resource
        <<: *get_options

      - task: build-message
        config:
          <<: *build_message_config
          inputs:
            - name: *oci_resource
          params:
            IMAGE_NAME: OCI-build
            RELEASE_URL: https://github.com/concourse/oci-build-task/releases
            RESOURCE_DIR: *oci_resource
      - *discord_notification

  - name: owncast
    plan:
      - get: *owncast_resource
        <<: *get_options

      - task: build-message
        config:
          <<: *build_message_config
          inputs:
            - name: *owncast_resource
          params:
            IMAGE_NAME: Owncast
            RELEASE_URL: https://github.com/owncast/owncast/releases
            RESOURCE_DIR: *owncast_resource
      - *discord_notification

  - name: vaultwarden
    plan:
      - get: *vaultwarden_resource
        <<: *get_options

      - task: build-message
        config:
          <<: *build_message_config
          inputs:
            - name: *vaultwarden_resource
          params:
            IMAGE_NAME: Vaultwarden
            RELEASE_URL: https://github.com/dani-garcia/vaultwarden/releases
            RESOURCE_DIR: *vaultwarden_resource
      - *discord_notification

  - name: wikijs
    plan:
      - get: *wikijs_resource
        <<: *get_options

      - task: build-message
        config:
          <<: *build_message_config
          inputs:
            - name: *wikijs_resource
          params:
            IMAGE_NAME: WikiJS
            RELEASE_URL: https://github.com/requarks/wiki/releases
            RESOURCE_DIR: *wikijs_resource
      - *discord_notification
